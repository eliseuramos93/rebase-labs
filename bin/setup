#!/bin/sh

APP_ROOT=$(dirname "$0")/..

system() {
  if ! "$@"; then
    echo "Erro ao executar $*"
    exit 1
  fi
}

finished_task() {
  echo "\nTarefa concluída!"
}

finished_setup() {
  echo "\n===== Configuração completa! =====\n\n"
  echo 'Você pode não ter permissão para excluir/alterar alguns arquivos que foram criados.'
  echo 'Caso seja necessário, execute o comando ** sudo chown -R $USER:$USER . ** para obter permissões.'
}

cd "$APP_ROOT" || exit

echo "\n===== 1. Executando Docker compose =====\n\n"
system docker compose up --build --no-recreate -d
finished_task

echo "\n===== 2. Instalando dependências =====\n\n"
system docker exec ruby bundle
finished_task

echo "\n===== 3. Inserindo informações no banco de dados =====\n\n"
system docker exec ruby ruby ./config/initializers/import_from_csv.rb
finished_task

echo "\n===== 4. Executando testes com RSpec =====\n\n"
system docker exec ruby rspec

echo "\n===== 5. Executando Rubocop =====\n\n"
system docker exec ruby rubocop
finished_setup
